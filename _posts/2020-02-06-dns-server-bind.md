---
layout: post
title: DNS сервер на примере BIND
date:   2020-02-06 17:45:33 +0500
categories: Разработка
tag: Linux
---
![Mind map по DNS](/blog/assets/images/dns-map-1.png)
# DNS сервер BIND текстовое представление Mind Map

## Структура DNS

- Вершина - корневая зона ".". Ее настройки всегда общедоступны. Информация о вершинах на серверах первого уровня.

- Домены первого \ верхнего уровня. TDL.

- Домены второго. N уровня.

- Имена хостов - задаются ресурсными или хостовыми записями.

## Терминология:

- **Зона** - часть дерева размещаемая как единое целое на некотором DNS. Имеется как минимум один авторитарный сервер хранящий информацию о зоне. Например cisco.ru.

- **Домен** - узел включающий в себя все подчиненные узлы. Например для cisco.ru подчиненные узлы будут n1.cisco.ru, test.cisco.ru.

- **FQDN** - полное определение доменного имени. Как абсолютный путь в файловой системе. FQDN - 256 байт с ограничением в 63 байта на каждое имя домена. Пример host.name. и "." в конце значит корневую зону.

## Клиенты DNS (resolver)

### Используют системные вызовы

- gethostbyname(2)
- gethostbyaddr(2)

### Ядро на основании файла `/etc/nsswitch.conf` определяет по какому пути действовать.

`cat /etc/nsswitch.conf`

```conf
hosts: file dns
networks: file /файл /etc/network
; Т.е. для преобразования имен хостов в IP сначало смотрим в hosts а затем запрос к DNS если там не оказалось.
```

### Если согласно `/etc/nsswitch.conf` запрос идет на DNS то исп `/etc/resolv.conf`.

`cat /etc/resolv.conf`

```conf
nameserver 192.168.1.1
nameserver 192.168.1.2
domain example.com ; имя по умолчанию если DNS не удается найти имя хоста.
domain и search вместе не применяются.
```

## Сервер DNS.

- **Главный DNS** (master, primary) - хранит главную копию файла доменных зон. Загружает информацию из конфигурационных файлов зоны. Авторитарен.

- **Вторичный** - копирует файлы с первичного. Авторитарен.

- **Кэширующий** - хранит ответы на предыдущие запросы. Не авторитарен.

## Type - тип записи:

### A - address record

- Отображает имя хоста (доменное имя) на адрес IPv4. Для каждого сетевого интерфейся машины должна быть сделан одна A запись.
- host.name. 86400 IN A 81.111.139.32

### AAAA

- Аналогично A записи только для IPv6.

### CNAME - canonical name

- Отображает алиас (псевдоним) на реальное имя, для перенаправления на другое имя.
- `ftp 86400 IN CHAME ftp.host.name.`

### MX - mail exchange

- Указывает хосты для доставки почты адресованной домену. При этом поле Name - домен назначения, Data - приоритет и DN хоста ответственного за прием почты.
- `host.name. 86400 IN MX 10 mx.host.name.`
- `host.name 86400 IN MX 20 mx2.host.name.`

### NS - name server

- Указывает DNS сервер обслуживающий зону.
- `name. 5772 IN NS l6.htn.com.`
- `name. 5772 IN NS m6.htm.com.`

### PTR - pointer.

- Отображает IP адрес в доменное имя, т.е. обратное преобразование имен.
- `81.111.139.32 86400 PTR host.name.`
- Имя 81.11.139.32 не заканчивается "." поэтому является относительным а не FQDN
- Для обратного преобразования имен используется специальный домен "in-addr.arpa."

### SOA - start of authority. Определяет зону ответственности сервера.

- Имя главного DNS
- Адрес администратора зоны.
- Серийный номер файла зоны, который нужно увеличивать при каждом изменении файла зоны.
- refresh - как часто вторичные DNS опрашивают первичные
- retry - кол-во попыток
- expire - максимальное время использования полученной информации о зоне.
- Min TTL
- `host.name. 86400 IN SOA ns1.test.ru hostmaster.test.ru. ( 2011032003 28800 7200 604800 86400`)

### SRV - server section

- Указывает на сервер обеспечивающий работу тех или иных служб. Например Jabber, AD, Proxy

## Ресурсная запись. Единица хранения и передачи информации в DNS.

### Символы в записях:

- ";" - вводит комментарий
- "#" - тоже комментарий только в версии BIND 4.9
- "@" - имя текущего домена
- "()" - позволяет данным занимать несколько строк
- "\*" - метасимвол, только в моле имя

- **Name** - доменное имя к которому привязаня \ принадлежит данная запись, либо IP адрес. При отсутствии этого поля, запись ресурса наследуется от предыдущей записи.

- **TTL** - время хранения записи в кэше. Может указываться в начале каждой записи либо в начале файла зоны и наследоваться всеми записями.

- **Class** - тип сети. В 99,99% это "IN" - Internet. Поле создано из предположения, что DNS может работать в сетях отличных от TCP\IP.

- **Type** - тип ресурсной записи.

## Ответ DNS можно помотреть утилитой dig

`dig yandex,ru`

![Mind map по настройке](/blog/assets/images/dns-map-2.png)

# Настройка BIND 9

## База данных прямого преобразования

** Расположение ** `/etc/bind/db.RS`

```conf
$TTL 5D; чтобы не записывать каждый раз TTL установил время жизни записи 5 дней
@ IN SOA skynet.local. skynetadmin.local. ( 100 10h 1h 1w 1d )
local. IN NS skynet.local.
skynet IN A 192.168.0.100 ; localhost, в частнотси на нем же прокси
88 IN A 192.168.88.7 ; Компьютер в сети
```

## База данных обратного преобразования имен для подсети 192.168.88.0

** Расположение ** `/etc/bind/db.rev88.RS`

```conf
$TTL 3600
88.168.192.in-addr.arpa. IN SOA skynet.local. skynetadmin.local. ( 100 10h 1h 1w 1d )
@ IN NS skynet.local
7 IN PTR 88.local. ; Компьютер c адресом 192.168.88.7
```

## Конфигурация локальных настроек

** Расположение ** `/etc/bind/named.conf.local`. Для любых локальных конфигураций.

```conf
zone "local" { type: master; file: "/etc/bind/db.RS ";}
zone "88.168.192.in-addr.arpa" { type: master; file: "/etc/bind/db.rev88.RS ";}
```

## Глобальные настройки DNS сервера

** Расположение ** `/etc/bind/named.conf.options`.

```conf
 options {
     directory "/var/cache/bind";
     forwarders {
         8.8.8.8;
         4.4.4.4
         };
     listen-on { 127.0.0.1 };
     allow-query { any };
     dnssec-validation auto;
     auth-nxdomain no;
     };
```

## Команды проверки работоспособности DNS

- `sudo named-checkconf -z` Проверяет файлы зон на наличие ошибок

- `sudo rndc reload` обновляет информацию о зонах

- `nslookup 192.168.0.100` или `nslookup skynet` проверка функционирования bind

## Пример настройки прямой почтовой зоны

```conf
 $TTL 5D
 @ IN SOA server2.rs.local. admin.rs.local. ( 110h 1h 1w 1d )
 rs.local. IN NS server2.rs.local.
 rs.local. IN TXT "V=spf1 ip4:34.10.88.120 +a -all" // Т.е. письма из нашего домена считаются отправленными с ip 34.10.88.120
 rs.local. IN SPF"V=spf1 ip4:34.10.88.120 -all" // Для новых DNS серверов аналогична предыдущей
 server2 IN A 34.10.88.120
 mail IN A 34.10.88.120
 pop IN CNAME mail.rs.local.
 smtp IN CNAME mail.rs.local.
 \_adsp.\_domaynkey.rs.local. TXT "dkim = all" // Все письма должны быть подписаны DKIM ключем
```
